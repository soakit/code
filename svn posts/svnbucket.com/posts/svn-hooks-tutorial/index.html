<!DOCTYPE html><html lang="zh-cn">
<!-- Mirrored from svnbucket.com/posts/svn-hooks-tutorial/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 23 Nov 2023 10:15:35 GMT -->
<head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> svn钩子教程 · SVN使用教程</title><meta name="description" content="讲解如何使用svn的钩子，用它来自动化我们的服务器代码更新"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="../favicon.png"><link rel="stylesheet" href="../css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="../atom.xml" title="SVN使用教程"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="../atom.xml" title="SVN使用教程" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="../index.html" class="logo-link"><img src="../favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="../index.html" target="_self" class="nav-list-link">文章列表</a></li><li class="nav-list-item"><a href="https://svnbucket.com/" target="_blank" class="nav-list-link">在线 SVN 服务器</a></li><li class="nav-list-item"><a href="https://www.bilibili.com/video/BV1k4411m7mP" target="_blank" class="nav-list-link">SVN 视频教程</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">svn钩子教程</h1><div class="post-info">2021年4月1日</div><div class="post-content"><p>钩子其实和回调是一个概念，当某个事情发生时就会调用你提供的方法，利用好SVN钩子可以大大的方便你的开发。<br>web 开发人员，每次提交了代码都需要手动到服务器更新下代码才能看到效果。<br>今天我就教大家如何利用钩子自动化更新。</p>
<span id="more"></span>

<p>下面我们将讲解在<code>SVNBucket</code>中如何配置钩子，如果你还没有<code>SVNBucket</code>帐号，<a href="https://svnbucket.com/">点击注册</a><br><img src="cBxz1x.md.jpg" alt="svnbucket 添加钩子"></p>
<p>在SVNBucket的项目详情页，我们打开钩子配置页面，如上图，点击添加钩子，我们需要填入 链接、token、触发条件</p>
<p><strong>链接</strong>：就好比我们的回调方法，在你提交代码后就会自动调用这个链接，你收到调用后就可以执行代码更新了。<br><strong>token</strong>：是一个可选的参数，在调用链接时会带上这个参数，可以用来检查调用是否来自 SVNBucket。这里可以随意填写一个自己想要的参数就行了<br><strong>触发条件</strong>：触发条件我们选择提交后，这样代码提交之后就会调用链接。<br><strong>备注</strong>：可以填写一个方便你记忆的名字，例如：更新测试服代码的钩子</p>
<p>那么我们的链接填写什么呢？你需要自己写一个http服务，用来接收调用。</p>
<h6 id="编写更新脚本"><a href="#编写更新脚本" class="headerlink" title="编写更新脚本"></a>编写更新脚本</h6><p>下面我以Python代码为例（PHP版本看文章最后），写一个简单的 http 服务来接收调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 你需要安装 flask：pip install flask</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/onCommit&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onCommit</span>():</span></span><br><span class="line">    <span class="comment"># 参数有：</span></span><br><span class="line">    <span class="comment"># event: 事件名字，有 start-commit（提交前）， post-commit（提交后）</span></span><br><span class="line">    <span class="comment"># token: 校验字符串，你在配置钩子那里填写的值</span></span><br><span class="line">    <span class="comment"># projectId: 项目ID</span></span><br><span class="line">    <span class="comment"># projectName: 项目名字</span></span><br><span class="line">    <span class="comment"># rev: 版本号（ post-commit 事件才有值）</span></span><br><span class="line">    <span class="comment"># txnName：事务名，例如：44-23</span></span><br><span class="line">    <span class="comment"># log：提交描述内容，</span></span><br><span class="line">    <span class="comment"># user：提交者用户名</span></span><br><span class="line">    <span class="comment"># changedDirs: 本次提交涉及哪些目录更新，多个用冒号拼接，例如：&quot;trunk/src:trunk/static&quot;（ post-commit 事件才有值），</span></span><br><span class="line">    <span class="comment"># 高级技巧：利用好 log、user、changedDirs 参数可以做选择性的更新，比如判断 log 中包含 “update” 才进行服务器更新；</span></span><br><span class="line">    <span class="comment"># 判断更新了某个目录中的文件才更新；</span></span><br><span class="line">    param = request.form</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印收到的参数</span></span><br><span class="line">    keys = param.keys()</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s=%s&#x27;</span> % (key, param.get(key, <span class="string">&#x27;&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验token，检查是不是自己在 SVNBucket 上配置的，防止恶意请求</span></span><br><span class="line">    <span class="keyword">if</span> param.get(<span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;&#x27;</span>) != <span class="string">&#x27;YourToken&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;token校验不对，忽略&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;invalid request&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提交成功后，进行服务器代码更新、重启服务器等操作</span></span><br><span class="line">    <span class="keyword">if</span> param.get(<span class="string">&#x27;event&#x27;</span>) == <span class="string">&#x27;post-commit&#x27;</span>:</span><br><span class="line">        <span class="comment"># 任何提交都更新</span></span><br><span class="line">        <span class="comment"># 调用shell脚本进行svn update</span></span><br><span class="line">        output = os.popen(<span class="string">&#x27;./up_and_restart.sh&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(output.read())</span><br><span class="line"></span><br><span class="line">        <span class="comment">## 高级用法：当log中包含udpate才更新</span></span><br><span class="line">        <span class="comment"># if &#x27;update&#x27; in param.get(&#x27;log&#x27;, &#x27;&#x27;):</span></span><br><span class="line">        <span class="comment">#    output = os.popen(&#x27;./up_and_restart.sh&#x27;)</span></span><br><span class="line">        <span class="comment">#    print output.read()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">## 高级用法：/trunk/src 目录变动了才更新</span></span><br><span class="line">        <span class="comment"># if &#x27;trunk/src&#x27; in param.get(&#x27;changedDirs&#x27;, &#x27;&#x27;):</span></span><br><span class="line">        <span class="comment">#    output = os.popen(&#x27;./up_and_restart.sh&#x27;)</span></span><br><span class="line">        <span class="comment">#    print output.read()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 这个响应内容会在钩子记录那里显示</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> param.get(<span class="string">&#x27;event&#x27;</span>) == <span class="string">&#x27;start-commit&#x27;</span>:</span><br><span class="line">        <span class="comment"># 如果是 start-commit 事件，必须返回 ok 才能提交，否则禁止提交并且会把返回的内容显示在 SVN 客户端。</span></span><br><span class="line">        <span class="comment"># 可以用来判断 log 是否符合规范，然后决定是否允许提交。</span></span><br><span class="line">        <span class="comment"># if len(param.get(&#x27;log&#x27;)) == 0:</span></span><br><span class="line">        <span class="comment">#     return &#x27;必须填写提交日志&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">    <span class="comment"># 测试钩子时事件名是 test</span></span><br><span class="line">    <span class="keyword">elif</span> param.get(<span class="string">&#x27;event&#x27;</span>) == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;test ok&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>这里我们用 Python 的 flask 框架搭建了一个简单的 http 服务来处理代码更新。根据这个可以自己实现一个其他语言的版本<br>在收到请求后我们就执行了一个shell脚本，这个shell脚本就是调用svn update去更新我们的代码了。<br><code>up_and_restart.sh</code>脚本内容类似以下内容（根据你的业务需求写）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">svn update /path/to/your/code/dir</span><br><span class="line">service restart xxxx</span><br></pre></td></tr></table></figure>

<p>假设你的服务器IP是<code>119.29.35.39</code>，http 服务的端口是8080，接口为 /afterCommit，那么我们就应该配置上面的链接地址为：<img src="2.jpg" alt="svn钩子使用教程"></p>
<p>配置好了后，我们可以点击测试按钮进行测试，这样就会手动的触发一次链接请求，并且在下面区域显示调用记录、是否成功<br><img src="ga33zhanmy000000.png" alt="svn钩子使用教程"></p>
<p>上面讲解的是提交后钩子的经典应用（更新代码）<br>提交前钩子最经典的应用是判断是否有填写描述内容，我们可以限制不填写提交描述就不给提交，SVNBucket 已经为你做好了这个功能，只需要在设置页面开启下就可以了。<br><img src="XHhOLDeZmz7QlV6.jpg" alt="svnbucket开启必须填写描述内容"></p>
<p>最后再提供一个PHP版本的供参考：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line">header(<span class="string">&quot;Content-Type: text/html; charset=utf-8&quot;</span>);</span><br><span class="line">header(<span class="string">&quot;Cache-Control:no-cache,must-revalidate&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 参数有：</span></span><br><span class="line"><span class="comment">// event: 事件名字，有 start-commit（提交前）， post-commit（提交后）</span></span><br><span class="line"><span class="comment">// token: 校验字符串，你在配置钩子那里填写的值</span></span><br><span class="line"><span class="comment">// projectId: 项目ID</span></span><br><span class="line"><span class="comment">// projectName: 项目名字</span></span><br><span class="line"><span class="comment">// rev: 版本号（ post-commit 事件才有值）</span></span><br><span class="line"><span class="comment">// txnName：事务名，例如：44-23</span></span><br><span class="line"><span class="comment">// log：提交描述内容，</span></span><br><span class="line"><span class="comment">// user：提交者用户名</span></span><br><span class="line"><span class="comment">// changedDirs: 本次提交涉及哪些目录更新，多个用冒号拼接，例如：&quot;trunk/src:trunk/static&quot;（ post-commit 事件才有值），</span></span><br><span class="line"><span class="comment">// 高级技巧：利用好 log、user、changedDirs 参数可以做选择性的更新，比如判断 log 中包含 “update” 才进行服务器更新；</span></span><br><span class="line"><span class="comment">// 判断更新了某个目录中的文件才更新；</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;token&#x27;</span>] === <span class="string">&#x27;你填写的Token值&#x27;</span>) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="string">&#x27;你的SVN用户名&#x27;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="string">&#x27;你的SVN密码&#x27;</span>;</span><br><span class="line">    <span class="variable">$target_dir</span> = <span class="string">&#x27;/data/www&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">    exec(<span class="string">&quot;svn up --username <span class="subst">$username</span> --password <span class="subst">$password</span> --no-auth-cache <span class="subst">$target_dir</span> 2&gt;&amp;1&quot;</span>, <span class="variable">$output</span>, <span class="variable">$outresult</span>);</span><br><span class="line">    print_r(<span class="string">&quot;\noutput:<span class="subst">$output</span>, result:<span class="subst">$outresult</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$outresult</span> ===<span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;更新成功！&#x27;</span>;</span><br><span class="line">        <span class="comment">//echo print_r($output);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;更新失败！&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> print_r(<span class="variable">$output</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;failed&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;数据校验失败，无效更新！&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;failed&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="../svn-commands-tutorial/index.html" class="prev">上一篇</a><a href="../svn-config-authz/index.html" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2023 <a href="https://svnbucket.com/posts">SVNBucket</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="http://cdn.bootcss.com/mathjax/2.7.0/MathJaxb198.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3Y0CZFQQH6"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3Y0CZFQQH6');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "../../../hm.baidu.com/hmd41d.js?" + '58e98965a39ff5dab9a778a4a30eca6b';
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

</script><script>//- 图片预览
let imgs = [...document.querySelectorAll("main img")]
let wrap = document.querySelector(".wrap")
imgs.forEach(img => {
	img.addEventListener("click", previewImg)
})
function previewImg(){
	let wrapper = document.createElement("div")
	wrapper.id = "preview-image-wrapper"
	let img = new Image()
	img.src = this.src
	wrapper.appendChild(img)
	document.body.appendChild(wrapper)

	//隐藏滚动条，防抖
	document.documentElement.style.overflowY = "hidden"
	wrap.style.paddingRight = "20px"

	wrapper.addEventListener("click", function(){
		document.body.removeChild(wrapper)
		wrapper = null
		document.documentElement.style.overflowY = "visible"
		wrap.style = ""
	})
}</script></body>
<!-- Mirrored from svnbucket.com/posts/svn-hooks-tutorial/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 23 Nov 2023 10:15:36 GMT -->
</html>